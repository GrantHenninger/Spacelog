{% extends "base.html" %}
{% load missiontime %}
{% load linkify %}
{% load pauses %}
{% load characters %}

{# for explanation of log_lines.0.1.0.1 see PageView.render_to_response. Shoot me now. #}
{# FIXME: make this into a variable in context #}
{% block full_title %}{{ mission.title }} transcript starting at {{ log_lines.0.1.0.1.timestamp|mission_time_format }} on Spacelog{% endblock %}

{% block extra_head %}{% if max_highlight_index > 0 %}
{% if log_lines.0.1.0.1.previous %}
<link rel="canonical" href="{% timestamp_to_url log_lines.0.1.0.1.timestamp %}">
{% else %}
<link rel="canonical" href="{% url view_page %}">
{% endif %}
{% endif %}{% endblock %}

{% comment %}
{% block extra_js %}<script type="text/javascript" src="{{ STATIC_URL }}js/page.js"></script>{% endblock %}
{% endcomment %}


{% block content-class %}transcript {% if max_highlight_index > 0 %}with-highlight{% endif %}{% endblock %}
{% block body-class %}transcript-section{% endblock %}

{% block crest %}
{% if log_lines.0.1.0.1.first_in_act and log_lines.0.1.0.1.act.banner %}
  {% with log_lines.0.1.0.1.act as act %}
    <div id='crest' {% if act.banner_class %}class='{{ act.banner_class }}'{% endif %}><div class='wrapper'>
        <p class='act-banner'><img class="act-banner" src="{{ MISSIONS_STATIC_URL }}{{ act.mission_name }}/images/banners/{{ act.banner }}"></p>
    </div></div>
  {% endwith %}
  {% else %}<div id="crest"></div>{% endif %}
{% endblock %}

{% block content %}
  
  <div class='nav'>
  {% if previous_timestamp %}
    <p id='load-previous' class='load-more'>
      <a href="{% timestamp_to_url previous_timestamp %}">Load previous&hellip;</a>
    </p>
  {% endif %}
  </div>

  <dl id='transcript'>
  {% for timestamp, inner_log_lines in log_lines %}
  <div>
  {% for transcript, log_line in inner_log_lines %}
  {% if log_line %}
    <div id="log-line-{{ log_line.timestamp }}" class='{% pause_class log_line.following_silence %} {% if log_line.highlighted %}highlighted {% if log_line.highlight_index == 1 %}first {% endif %}{% if log_line.highlight_index == max_highlight_index %}last{% endif %}{% endif %}{% if log_line.key_scene_number %} key-scene{% endif %}'
      {% if log_line.transcript_page %}data-transcript-page='{{ log_line.transcript_page }}'{% endif %}>
    {% for speaker, text in log_line.lines %}
      <dt class='time'{% if log_line.pre_highlight %} id='show-selection'{% endif %}>
        <a href='{% selection_url log_line.timestamp %}'>
          <time datetime="{{ log_line.utc_time|date:"Y-m-d\TH:i:s\Z" }}" data-range-advisory="{{ log_line.utc_time }} UTC ({{ log_line.utc_time|timesince }} ago)">
            {{log_line.timestamp|mission_time_format}}
          </time>
        </a>
      </dt>
      <dt class='speaker'>
        {% avatar_and_name speaker mission.name log_line.timestamp %}
      </dt>
      <dd class='{% pause_class log_line.following_silence %}'>
      <p>
        {% if log_line.first_in_key_scene %}
        <em><i>Key moment</i> {{ log_line.key_scene.title|safe }}<span>: </span></em>
        {% endif %}
        {{text|safe}}
      </p>
        {% if log_line.highlight_index == 1 and log_line.previous_timestamp %}
          <a href='{% selection_url log_line.previous_timestamp selection_end_timestamp %}' class='range-ui' id='expand-previous'><span>Expand selection up</span></a>
        {% endif %}
        {% if log_line.highlight_index == 1 and log_line.next_timestamp and log_line.next_timestamp <= selection_end_timestamp %}
          <a href='{% selection_url log_line.next_timestamp selection_end_timestamp %}' class='range-ui' id='contract-previous'><span>Contract selection down</span></a>
        {% endif %}

        {% if log_line.highlight_index == max_highlight_index and log_line.next_timestamp %}
          <a href='{% selection_url selection_start_timestamp log_line.next_timestamp %}' class='range-ui' id='expand-next'><span>Expand selection down</span></a>
        {% endif %}
        {% if log_line.highlight_index == max_highlight_index and log_line.previous_timestamp and log_line.previous_timestamp >= selection_start_timestamp %}
          <a href='{% selection_url selection_start_timestamp log_line.previous_timestamp %}' class='range-ui' id='contract-next'><span>Contract selection up</span></a>
        {% endif %}
        {% if log_line.highlight_index == 1 %}
            <a href='{% timestamp_to_url log_line.timestamp selection_start_timestamp %}' class='range-ui' id='selection-close'><span>Close</span></a>
            <!-- Our MET in seconds is {{ log_line.timestamp }} -->
        {% endif %}

        {# Labels #}
        {% if log_line.labels %}
          <span class='labels'>{{ log_line.labels|length }} label{{ log_line.labels|length|pluralize }}</span>
        {% endif %}

        {# Images #}
        {% if forloop.last %}
          {% for image in log_line.images %}
            <div class='image'>
                <a href="{{ MISSIONS_IMAGE_URL }}{{ mission.name }}/images/media/{{ image.filename }}">
                    <img src="{{ MISSIONS_IMAGE_URL }}{{ mission.name }}/images/media/{{ image.thumbnail_filename }}" />
              </a>
            </div>
            {% endfor %}
        {% endif %}
      </dd>
    {% endfor %}{# speaker, text #}
    {% if log_line.highlight_index == max_highlight_index %}
    <p id='range-advisory'>
    Spoken on {{ first_highlighted_line.utc_time }} UTC ({{ first_highlighted_line.utc_time|timesince }} ago)<span>. </span>
    <i>Link to this<span> transcript range is</span>:</i>
    <input type="text" name="" value="{{ permalink }}">
    <a title="Tweet this transcript range" href="http://twitter.com/share?url={{ permalink|urlencode:'' }}&amp;text={{ first_highlighted_line.lines.0.1|truncatewords:15|urlencode }}">Tweet</a>
    </p>
    {% endif %}
    {% if log_line.following_silence > 3600 and max_highlight_index %}
     <dd class='extended-pause'>No contact for {% pause_length log_line.following_silence %}</dd>
    {% endif %}
    </div>
    {% if log_line.following_silence > 3600 %}
    {% if max_highlight_index and log_line.highlight_index == max_highlight_index %}
     <dd class='extended-pause'>No contact for {% pause_length log_line.following_silence %}</dd>
    {% endif %}
    {% if not max_highlight_index %}
     <dd class='extended-pause'>No contact for {% pause_length log_line.following_silence %}</dd>
    {% endif %}
    {% endif %}
  {% else %}
  <div>Placeholder for {{ transcript }}</div>
  {% endif %}
  {% endfor %}{# inner_log_lines #}
  </div>
  {% endfor %}{# log_lines #}
  </dl>

  <div class='nav after'>
  {% if next_timestamp %}
    <p id='load-more' class='load-more'>
      <a href="{% timestamp_to_url next_timestamp "" transcript %}">Load more&hellip;</a>
    </p>
  {% endif %}
  </div>

  <div id='phases'>
    <div class='inner'><div class='wrapper'>
      <nav>
        {% if original_transcript_page %}
          <p class='original'>
            <a href="{% url original original_transcript_page %}">View original</a>
          </p>
        {% endif %}
        <ul>
        {% if previous_act %}
          {% ifequal previous_act.number 0 %}
          <li><a href='{% url view_page %}' rel='prev'><span>Previous</span></a></li>
          {% else %}
          <li><a href='{% timestamp_to_url previous_act.start %}' rel='prev'><span>Previous</span></a></li>
          {% endifequal %}
        {% else %}
          <li class='prev'><span>Previous</span></li>
        {% endif %}
        <li><em><a href='{% url phases current_act.one_based_number %}'>Phase {{ act }}: {{ current_act.title }}</a></em></li>
        {% if next_act %}
          <li><a href='{% timestamp_to_url next_act.start %}' rel='next'><span>Next</span></a></li>
        {% else %}
          <li class='next'><span>Next</span></li>
        {% endif %}
        <li id='fb-like'>{# Facebook like button #}
          <fb:like href="{{ MISSION_URL }}" layout="button_count" show_faces="false" width="85"></fb:like>
        </li>
      </ul></nav>
      {% if current_act.orbital %}
      <img class='orbital' src='{{ MISSIONS_STATIC_URL }}{{ mission.name }}/images/orbital/{{ current_act.orbital }}'>
      {% endif %}
    </div></div>
  </div>
  <script src="http://connect.facebook.net/en_US/all.js#xfbml=1"></script>
{% endblock %}
