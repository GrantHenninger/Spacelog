{% extends "base.html" %}
{% load missiontime %}
{% load linkify %}
{% load pauses %}
{% load characters %}

{% block title %}Transcript - Starting at {{ log_lines.0.timestamp|mission_time_format }}{% endblock %}

{% block content-class %}transcript {% if max_highlight_index > 0 %}with-highlight{% endif %}{% endblock %}

{% block crest %}
{% if log_lines.0.first_in_act and log_lines.0.act.banner %}
  {% with log_lines.0.act as act %}
    <div id='crest' {% if act.banner_class %}class='{{ act.banner_class }}'{% endif %}><div class='wrapper'>
    <p class='act-banner'><img class="act-banner" src="/assets/img/acts/{{ act.mission_name }}/{{ act.banner }}"></p>
    </div></div>
  {% endwith %}
{% endif %}
{% endblock %}

{% block content %}
  
  <div class='nav'>
  {% if previous_timestamp and not max_highlight_index %}
    <p class='load-more'>
      <a href="{% timestamp_to_url previous_timestamp %}">Previous
         dialogue</a>
    </p>
  {% endif %}
  {% if log_lines.0.transcript_page %}
    <p class='original'>
      <a href="{% url original log_lines.0.transcript_page %}">View original transcript</a>
    </p>
  {% endif %}
  </div>

  <dl id='transcript'>
  {% for log_line in log_lines %}
    {% for speaker, text in log_line.lines %}
    <div id="log-line-{{ log_line.timestamp }}">
      <dt class='time {% if log_line.highlighted %}highlighted {% endif %}'{% if log_line.pre_highlight %} id='show-selection'{% endif %}>
        <a href='{% selection_url log_line.timestamp %}'>
          <time datetime="{{ log_line.utc_time|date:"Y-m-d\TH:i:s\Z" }}">
            {{log_line.timestamp|mission_time_format}}
          </time>
        </a>
      </dt>
      <dt class='speaker {% if log_line.highlighted %}highlighted{% endif %}'>
        {% avatar_and_name speaker log_line.timestamp %}
      </dt>
      <dd class='{% pause_class log_line.following_silence %} {% if log_line.highlighted %}highlighted {% if log_line.highlight_index == 1 %}first {% endif %}{% if log_line.highlight_index == max_highlight_index %}last{% endif %}{% endif %}'>
      <p><a href='{% selection_url log_line.timestamp %}'>{{text|linkify|safe}}</a></p>
        {% if log_line.highlight_index == 1 and log_line.previous_timestamp %}
          <a href='{% selection_url log_line.previous_timestamp selection_end_timestamp %}'>Expand selection up</a>
        {% endif %}
        {% if log_line.highlight_index == 1 and log_line.next_timestamp and log_line.next_timestamp <= selection_end_timestamp %}
          <a href='{% selection_url log_line.next_timestamp selection_end_timestamp %}'>Contract selection down</a>
        {% endif %}

        {% if log_line.highlight_index == max_highlight_index and log_line.next_timestamp %}
          <a href='{% selection_url selection_start_timestamp log_line.next_timestamp %}'>Expand selection down</a>
        {% endif %}
        {% if log_line.highlight_index == max_highlight_index and log_line.previous_timestamp and log_line.previous_timestamp >= selection_start_timestamp %}
          <a href='{% selection_url selection_start_timestamp log_line.previous_timestamp %}'>Contract selection up</a>
        {% endif %}
        {% if log_line.highlight_index == max_highlight_index %}
            <a href='{% timestamp_to_url log_line.timestamp selection_start_timestamp %}'>Close</a>
            <!-- Our MET in seconds is {{ log_line.timestamp }} -->
        {% endif %}

        {% if log_line.following_silence > 3600 %}
          <span class='extended-pause'>No contact for {% pause_length log_line.following_silence %}</span>
        {% endif %}

        {# Labels #}
        {% if log_line.labels %}
          <span class='labels'>{{ log_line.labels|length }} label{{ log_line.labels|length|pluralize }}</span>
        {% endif %}

        {# Images #}
        {% if forloop.last %}
          {% for image in log_line.images %}
            <div class='image'>
                <a href="/assets/img/missions/{{ log_line.mission_name }}/{{ image.filename }}">
                    <img src="/assets/img/missions/{{ log_line.mission_name }}/{{ image.thumbnail_filename }}" />
              </a>
            </div>
            {% endfor %}
        {% endif %}
      </dd>
      </div>
    {% endfor %}
  {% endfor %}
  </dl>

  <div class='nav after'>
  {% if next_timestamp and not max_highlight_index %}
    <p class='load-more'>
      <a href="{% timestamp_to_url next_timestamp %}">Next
         dialogue</a>
    </p>
  {% endif %}
  </div>

  <div id='phases'><div class='shim'>
    <div class='wrapper'>
      <nav><ul>
        {% if previous_act %}
          <li><a href='{% timestamp_to_url previous_act.start %}' rel='prev'>Previous</a></li>
        {% else %}
          <li><span class='prev'>Previous</span></li>
        {% endif %}
        <li><em>Phase {{ act }}: {{ current_act.title }}</em></li>
        {% if next_act %}
          <li><a href='{% timestamp_to_url next_act.start %}' rel='next'>Next</a></li>
        {% else %}
          <li><span class='next'>Next</span></li>
        {% endif %}
      </ul></nav>
      <img src='/assets/img/missions/{{ mission.name }}/act{{ act }}.png'>
    </div></div>
  </div>
  
{% endblock %}
